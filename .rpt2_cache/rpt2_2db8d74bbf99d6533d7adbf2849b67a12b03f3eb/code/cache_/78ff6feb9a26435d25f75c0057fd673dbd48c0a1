{"code":"import { Observable } from 'rxjs';\r\nimport { share } from 'rxjs/operators';\r\nimport { UInt16, UInt32, UInt8 } from './Types';\r\nexport class PacketStream {\r\n    constructor(...packetTypes) {\r\n        const keyValueArray = packetTypes.map(packetClass => [new packetClass().packetType, packetClass]);\r\n        this.packetTypeMap = new Map(keyValueArray);\r\n        if (packetTypes.length > 0) {\r\n            const structureMetadata = new packetTypes[0]().structureMetadata;\r\n            const packetTypeMetadata = structureMetadata.packetType;\r\n            this.fieldType = packetTypeMetadata.type;\r\n        }\r\n    }\r\n    attachToStream(readable) {\r\n        return Observable.create(observer => {\r\n            this.lockReadbleToSubscriber(readable, observer);\r\n            const numberOfRequiredBytes = this.fieldType.size;\r\n            const listener = () => {\r\n                if (readable.readableLength >= numberOfRequiredBytes) {\r\n                    const data = readable.read(numberOfRequiredBytes);\r\n                    const type = this.readTypedFieldFromBuffer(data);\r\n                    const incomingPacketType = this.packetTypeMap.get(type);\r\n                    if (incomingPacketType !== undefined) {\r\n                        readable.unshift(data);\r\n                        const incomingPacketClass = incomingPacketType.constructor;\r\n                        const packet = new incomingPacketClass();\r\n                        readable.removeListener('readable', listener);\r\n                        packet.readFrom(readable).subscribe(() => {\r\n                            const event = new PacketEventImp();\r\n                            event.packetClass = incomingPacketClass;\r\n                            event.packet = packet;\r\n                            observer.next(event);\r\n                            process.nextTick(() => {\r\n                                listener();\r\n                            });\r\n                            readable.on('readable', listener);\r\n                        });\r\n                    }\r\n                    else {\r\n                        process.nextTick(() => {\r\n                            listener();\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n            readable.on('readable', listener);\r\n            listener();\r\n        }).pipe(share());\r\n    }\r\n    addPacketType(packetType) {\r\n        const instance = new packetType();\r\n        if (this.fieldType === undefined) {\r\n            const structureMetadata = instance.structureMetadata;\r\n            const packetTypeMetadata = structureMetadata.packetType;\r\n            this.fieldType = packetTypeMetadata.type;\r\n        }\r\n        this.packetTypeMap.set(instance.packetType, packetType);\r\n    }\r\n    removePacketType(packetType) {\r\n        this.packetTypeMap.delete(new packetType().packetType);\r\n    }\r\n    lockReadbleToSubscriber(readable, subscriber) {\r\n        if (readable[READABLE_LOCK_SYMBOL] !== undefined) {\r\n            throw {\r\n                name: 'Packet Stream Concurrency Error',\r\n                message: 'Attempted to attach more than one PacketStream to the same ReadStream.'\r\n            };\r\n        }\r\n        readable[READABLE_LOCK_SYMBOL] = true;\r\n        const unsubscribe = subscriber.unsubscribe.bind(subscriber);\r\n        subscriber.unsubscribe = () => {\r\n            readable[READABLE_LOCK_SYMBOL] = undefined;\r\n            unsubscribe();\r\n        };\r\n    }\r\n    readTypedFieldFromBuffer(buffer) {\r\n        switch (this.fieldType) {\r\n            case UInt8:\r\n                return buffer.readUInt8(0);\r\n            case UInt16:\r\n                return buffer.readUInt16BE(0);\r\n            case UInt32:\r\n                return buffer.readUInt32BE(0);\r\n        }\r\n    }\r\n}\r\n/* tslint:disable:max-classes-per-file */\r\nclass PacketEventImp {\r\n    if(targetClass, handler) {\r\n        if (this.packetClass === targetClass) {\r\n            handler(this.packet);\r\n        }\r\n    }\r\n}\r\nconst READABLE_LOCK_SYMBOL = Symbol('PacketStreamLock');\r\n//# sourceMappingURL=PacketStream.js.map","map":"{\"version\":3,\"file\":\"PacketStream.js\",\"sourceRoot\":\"\",\"sources\":[\"../../lib/PacketStream.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/Chris/Projects/ts-packet/PacketStream.d.ts","writeByteOrderMark":false,"text":"/// <reference types=\"node\" />\r\nimport ReadStream = NodeJS.ReadStream;\r\nimport { Observable } from 'rxjs';\r\nimport { AbstractPacket } from './AbstractPacket';\r\nimport { Class, UInt16, UInt32, UInt8 } from './Types';\r\ndeclare type PacketTypeTypes = UInt8 | UInt16 | UInt32;\r\nexport interface TypedPacket<T extends PacketTypeTypes> extends AbstractPacket {\r\n    packetType: T;\r\n}\r\nexport interface PacketEvent<T extends PacketTypeTypes> {\r\n    readonly packet: TypedPacket<T>;\r\n    readonly packetClass: Class<TypedPacket<T>>;\r\n    if: <P extends TypedPacket<T>>(targetClass: Class<P>, handler: (packet: P) => void) => void;\r\n}\r\nexport declare class PacketStream<T extends PacketTypeTypes> {\r\n    private readonly packetTypeMap;\r\n    private fieldType;\r\n    constructor(...packetTypes: Class<TypedPacket<T>>[]);\r\n    attachToStream(readable: ReadStream): Observable<PacketEvent<T>>;\r\n    addPacketType(packetType: Class<TypedPacket<T>>): void;\r\n    removePacketType(packetType: Class<TypedPacket<T>>): void;\r\n    private lockReadbleToSubscriber;\r\n    private readTypedFieldFromBuffer;\r\n}\r\nexport {};\r\n"}}
